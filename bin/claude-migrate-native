#!/bin/bash
# claude-migrate-native - Migrate Claude Code from Homebrew to native installer
#
# Run this after closing all Claude Code sessions. It uninstalls the Homebrew
# cask and installs the native binary, which auto-updates in the background
# so you never have to close sessions for upgrades again.

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check for running Claude Code sessions
if pgrep -f "claude" | grep -v $$ | grep -v grep > /dev/null 2>&1; then
    echo -e "${RED}Claude Code sessions may still be running.${NC}"
    echo -e "${YELLOW}Close all sessions first, then re-run this script.${NC}"
    echo ""
    echo "Running processes:"
    pgrep -af "claude" | grep -v $$ | grep -v grep || true
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Step 1: Record current version
CURRENT_VERSION=$(claude --version 2>/dev/null || echo "unknown")
echo -e "${BLUE}Current install: Homebrew, version ${CURRENT_VERSION}${NC}"
echo ""

# Step 2: Uninstall Homebrew cask
if brew list --cask claude-code &>/dev/null; then
    echo -e "${YELLOW}Uninstalling Homebrew cask...${NC}"
    brew uninstall --cask claude-code
    echo -e "${GREEN}Homebrew cask removed.${NC}"
else
    echo -e "${YELLOW}Homebrew cask not found, skipping uninstall.${NC}"
fi

# Step 3: Install native binary
echo ""
echo -e "${BLUE}Installing native binary...${NC}"
curl -fsSL https://claude.ai/install.sh | bash

# Step 4: Verify
echo ""
if command -v claude &>/dev/null; then
    NEW_VERSION=$(claude --version 2>/dev/null || echo "unknown")
    echo -e "${GREEN}Migration complete.${NC}"
    echo -e "  Install: native (~/.local/bin/claude)"
    echo -e "  Version: ${NEW_VERSION}"
    echo -e "  Auto-updates: enabled (background)"
    echo ""
    echo -e "${BLUE}Tips:${NC}"
    echo -e "  - Set stable channel:  claude config set autoUpdatesChannel stable"
    echo -e "  - Disable auto-update: export DISABLE_AUTOUPDATER=1"
    echo -e "  - Manual update:       claude update"
else
    echo -e "${RED}claude not found in PATH after install.${NC}"
    echo -e "You may need to add ~/.local/bin to your PATH:"
    echo -e '  export PATH="$HOME/.local/bin:$PATH"'
    exit 1
fi
