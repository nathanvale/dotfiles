#!/bin/bash
# addenv - Add an environment variable to your dotfiles
# Usage: addenv KEY_NAME "value" -p|--provider <name> [-u|--url <url>] [-e|--expiry <date>]
#
# Two modes:
#   1Password Mode: Keys stored in 1Password vault, .env auto-generated
#   Manual Mode:    Keys stored directly in .env file (no sync capability)
#
# Provider is MANDATORY - keys are grouped by provider for easy management

set -e

VAULT="Dotfiles"
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/code/dotfiles}"
ENV_FILE="$DOTFILES_DIR/.env"
EXAMPLE_FILE="$DOTFILES_DIR/.env.example"
SCRIPT_DIR="$(dirname "$0")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[0;90m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }
log_dim() { echo -e "${DIM}$1${NC}"; }

usage() {
    echo "Usage: addenv KEY_NAME \"value\" -p|--provider <name> [-u|--url <url>] [-e|--expiry <date>]"
    echo ""
    echo "Add an environment variable to your dotfiles."
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  KEY_NAME              Environment variable name (UPPERCASE_WITH_UNDERSCORES)"
    echo "  value                 The secret value"
    echo ""
    echo -e "${CYAN}Required Flags:${NC}"
    echo "  -p, --provider <name> Provider name (e.g., openai, stripe, tavily)"
    echo ""
    echo -e "${CYAN}Optional Flags:${NC}"
    echo "  -u, --url <url>       URL where to get/regenerate this key"
    echo "  -e, --expiry <date>   Expiration date (YYYY-MM-DD) or relative (30d, 6m, 1y)"
    echo "  -h, --help            Show this help message"
    echo ""
    echo -e "${CYAN}Two modes available:${NC}"
    echo ""
    echo -e "  ${GREEN}1Password Mode${NC} (if 'op' CLI is installed & authenticated)"
    echo "    - Keys stored securely in 1Password vault with provider tags"
    echo "    - .env file auto-regenerated from 1Password"
    echo "    - Expiry tracking with 1Password notifications"
    echo "    - Sync across machines with 'syncenv'"
    echo "    - Filter by provider with 'lsenv --provider <name>'"
    echo ""
    echo -e "  ${YELLOW}Manual Mode${NC} (fallback if no 1Password)"
    echo "    - Keys stored directly in .env file with provider comments"
    echo "    - No sync capability, but provider grouping still tracked"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  # Full example with all options"
    echo "  addenv OPENAI_API_KEY \"sk-xxx\" -p openai -u \"https://platform.openai.com/api-keys\" -e 1y"
    echo ""
    echo "  # With provider and URL only"
    echo "  addenv STRIPE_KEY \"sk_live_xxx\" --provider stripe --url \"https://dashboard.stripe.com/apikeys\""
    echo ""
    echo "  # With provider and expiry only"
    echo "  addenv TAVILY_API_KEY \"tvly-xxx\" -p tavily -e 90d"
    echo ""
    echo "  # Minimal (just provider)"
    echo "  addenv MY_SECRET \"secret\" -p internal"
    echo ""
    echo -e "${CYAN}List keys by provider:${NC}"
    echo "  lsenv --provider openai    # Show all OpenAI keys"
    echo "  lsenv --providers          # List all providers"
    exit 1
}

# Parse relative date to absolute date
parse_expiry_date() {
    local input="$1"

    # If already in YYYY-MM-DD format, return as-is
    if [[ "$input" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        echo "$input"
        return
    fi

    # Parse relative dates (30d, 6m, 1y, etc.)
    if [[ "$input" =~ ^([0-9]+)([dDmMyY])$ ]]; then
        local num="${BASH_REMATCH[1]}"
        local unit="${BASH_REMATCH[2]}"

        case "${unit,,}" in
            d) # days
                if [[ "$(uname)" == "Darwin" ]]; then
                    date -v+"${num}d" "+%Y-%m-%d"
                else
                    date -d "+${num} days" "+%Y-%m-%d"
                fi
                ;;
            m) # months
                if [[ "$(uname)" == "Darwin" ]]; then
                    date -v+"${num}m" "+%Y-%m-%d"
                else
                    date -d "+${num} months" "+%Y-%m-%d"
                fi
                ;;
            y) # years
                if [[ "$(uname)" == "Darwin" ]]; then
                    date -v+"${num}y" "+%Y-%m-%d"
                else
                    date -d "+${num} years" "+%Y-%m-%d"
                fi
                ;;
        esac
        return
    fi

    # Invalid format
    echo ""
}

# Initialize variables
KEY_NAME=""
KEY_VALUE=""
KEY_PROVIDER=""
KEY_URL=""
KEY_EXPIRY=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            ;;
        -p|--provider)
            if [[ -z "$2" || "$2" == -* ]]; then
                log_error "Option $1 requires a provider name"
                exit 1
            fi
            KEY_PROVIDER="$2"
            shift 2
            ;;
        -u|--url)
            if [[ -z "$2" || "$2" == -* ]]; then
                log_error "Option $1 requires a URL"
                echo ""
                echo "Tip: Quote URLs containing # (fragment identifiers):"
                echo "  -u \"https://example.com/page#section\""
                exit 1
            fi
            KEY_URL="$2"
            shift 2
            ;;
        -e|--expiry)
            if [[ -z "$2" || "$2" == -* ]]; then
                log_error "Option $1 requires an expiry date"
                exit 1
            fi
            KEY_EXPIRY="$2"
            shift 2
            ;;
        -*)
            log_error "Unknown option: $1"
            echo ""
            echo "Usage: addenv KEY_NAME \"value\" -p provider [-u url] [-e expiry]"
            echo ""
            echo "Did you mean to run a different command?"
            echo "  addenv             - Add a new environment variable"
            echo "  lsenv              - List environment variables"
            echo "  syncenv            - Sync .env from 1Password"
            echo "  sync-docker-mcp    - Sync .env to Docker MCP"
            exit 1
            ;;
        *)
            # Positional arguments: KEY_NAME and value
            if [[ -z "$KEY_NAME" ]]; then
                KEY_NAME="$1"
            elif [[ -z "$KEY_VALUE" ]]; then
                KEY_VALUE="$1"
            else
                log_error "Unexpected argument: $1"
                echo "Use --help for usage information"
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate required arguments
if [[ -z "$KEY_NAME" ]]; then
    log_error "Missing KEY_NAME"
    usage
fi

if [[ -z "$KEY_VALUE" ]]; then
    log_error "Missing value"
    usage
fi

if [[ -z "$KEY_PROVIDER" ]]; then
    log_error "Missing required --provider flag"
    echo ""
    echo "Example: addenv $KEY_NAME \"...\" -p openai"
    echo ""
    usage
fi

# Validate key name - must be uppercase with underscores
if [[ ! "$KEY_NAME" =~ ^[A-Z][A-Z0-9_]*$ ]]; then
    log_error "Invalid key name: $KEY_NAME"
    echo "Key names must be uppercase with underscores (e.g., LINKEDIN_COOKIE, OPENAI_API_KEY)"
    exit 1
fi

# Validate and normalize provider name (lowercase, alphanumeric with hyphens)
KEY_PROVIDER=$(echo "$KEY_PROVIDER" | tr '[:upper:]' '[:lower:]')
if [[ ! "$KEY_PROVIDER" =~ ^[a-z][a-z0-9-]*$ ]]; then
    log_error "Invalid provider name: $KEY_PROVIDER"
    echo "Provider names must be lowercase alphanumeric with hyphens (e.g., openai, azure-ai)"
    exit 1
fi

# Parse expiry date if provided
EXPIRY_DATE=""
if [[ -n "$KEY_EXPIRY" ]]; then
    EXPIRY_DATE=$(parse_expiry_date "$KEY_EXPIRY")
    if [[ -z "$EXPIRY_DATE" ]]; then
        log_error "Invalid expiry date format: $KEY_EXPIRY"
        echo "Use YYYY-MM-DD or relative format (30d, 6m, 1y)"
        exit 1
    fi
fi

# Check if 1Password CLI is available
if command -v op &> /dev/null; then
    # Test if we can actually use 1Password (authenticated)
    if op vault list &> /dev/null; then
        MODE="1password"
    else
        MODE="manual"
        log_warn "1Password CLI found but not authenticated"
    fi
else
    MODE="manual"
fi

# Function to update .env.example
update_example() {
    local key="$1"
    local url="$2"

    # Create .env.example if it doesn't exist
    if [[ ! -f "$EXAMPLE_FILE" ]]; then
        cat > "$EXAMPLE_FILE" << 'EOF'
# .env.example - Template for environment variables
# Copy to .env and fill in your actual values
# This file is safe to commit to git

EOF
    fi

    # Check if key already exists in .env.example
    if grep -q "^export ${key}=" "$EXAMPLE_FILE" 2>/dev/null; then
        log_dim "Key already in .env.example"
        return
    fi

    # Add to .env.example with placeholder
    if [[ -n "$url" ]]; then
        echo "" >> "$EXAMPLE_FILE"
        echo "# $key ($url)" >> "$EXAMPLE_FILE"
    else
        echo "" >> "$EXAMPLE_FILE"
        echo "# $key" >> "$EXAMPLE_FILE"
    fi
    echo "export ${key}=\"xxx-placeholder\"" >> "$EXAMPLE_FILE"
    log_success "Added $key to .env.example"
}

if [[ "$MODE" == "1password" ]]; then
    echo ""
    log_dim "Mode: 1Password (synced)"
    echo ""
    log_info "Adding $KEY_NAME to 1Password vault: $VAULT"
    log_info "Provider: $KEY_PROVIDER"

    # Check if item already exists
    EXISTING_ID=$(op item list --vault "$VAULT" --format json 2>/dev/null | jq -r ".[] | select(.title == \"$KEY_NAME\") | .id" || echo "")

    # Build the op command arguments
    OP_ARGS=("credential=$KEY_VALUE")

    if [[ -n "$EXPIRY_DATE" ]]; then
        OP_ARGS+=("Expiry Date[date]=$EXPIRY_DATE")
        log_info "Expiry date: $EXPIRY_DATE"
    fi

    if [[ -n "$EXISTING_ID" ]]; then
        log_warn "Key $KEY_NAME already exists, updating..."
        # Update existing item with new tag
        if [[ -n "$KEY_URL" ]]; then
            op item edit "$KEY_NAME" \
                --vault "$VAULT" \
                --url "$KEY_URL" \
                --tags "$KEY_PROVIDER" \
                "${OP_ARGS[@]}" \
                > /dev/null
        else
            op item edit "$KEY_NAME" \
                --vault "$VAULT" \
                --tags "$KEY_PROVIDER" \
                "${OP_ARGS[@]}" \
                > /dev/null
        fi
        log_success "Updated $KEY_NAME in 1Password (provider: $KEY_PROVIDER)"
    else
        # Create new API Credential item with provider tag
        if [[ -n "$KEY_URL" ]]; then
            op item create \
                --category "API Credential" \
                --vault "$VAULT" \
                --title "$KEY_NAME" \
                --url "$KEY_URL" \
                --tags "$KEY_PROVIDER" \
                "${OP_ARGS[@]}" \
                > /dev/null
        else
            op item create \
                --category "API Credential" \
                --vault "$VAULT" \
                --title "$KEY_NAME" \
                --tags "$KEY_PROVIDER" \
                "${OP_ARGS[@]}" \
                > /dev/null
        fi
        log_success "Created $KEY_NAME in 1Password (provider: $KEY_PROVIDER)"
    fi

    if [[ -n "$EXPIRY_DATE" ]]; then
        log_dim "1Password will track expiry and can notify you before it expires"
    fi

    # Update .env.example
    update_example "$KEY_NAME" "$KEY_URL"

    # Regenerate .env file
    log_info "Regenerating .env from 1Password..."
    "$SCRIPT_DIR/syncenv"

    log_success "Done! $KEY_NAME is now stored in 1Password and synced to .env"

    # Sync to Docker MCP if available (skip 1Password sync since we just did it)
    if command -v docker &> /dev/null && docker mcp secret ls &> /dev/null; then
        log_info "Syncing to Docker MCP..."
        "$SCRIPT_DIR/sync-docker-mcp" --no-sync 2>/dev/null || log_warn "Run 'sync-docker-mcp --setup' to configure mappings"
    fi

else
    # Manual mode - direct .env editing
    echo ""
    log_dim "Mode: Manual (no 1Password)"
    log_dim "Keys will be stored directly in .env - no sync capability"
    log_info "Provider: $KEY_PROVIDER"
    if [[ -n "$EXPIRY_DATE" ]]; then
        log_warn "Expiry tracking not available in manual mode (install 1Password CLI)"
    fi
    echo ""

    # Create .env if it doesn't exist
    if [[ ! -f "$ENV_FILE" ]]; then
        cat > "$ENV_FILE" << 'EOF'
# .env - Environment variables (manually managed)
# Add keys with: addenv KEY_NAME "value" -p provider [-u url] [-e expiry]

EOF
        chmod 600 "$ENV_FILE"
        log_info "Created $ENV_FILE"
    fi

    # Check if key already exists in .env
    if grep -q "^export ${KEY_NAME}=" "$ENV_FILE" 2>/dev/null; then
        # Update existing key (preserve any existing comment)
        log_warn "Key $KEY_NAME already exists, updating value..."
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "s|^export ${KEY_NAME}=.*|export ${KEY_NAME}=\"${KEY_VALUE}\"|" "$ENV_FILE"
        else
            sed -i "s|^export ${KEY_NAME}=.*|export ${KEY_NAME}=\"${KEY_VALUE}\"|" "$ENV_FILE"
        fi
        log_success "Updated $KEY_NAME in .env (provider: $KEY_PROVIDER)"
    else
        # Add new key with comment including provider
        echo "" >> "$ENV_FILE"
        COMMENT="# $KEY_NAME [provider: $KEY_PROVIDER]"
        if [[ -n "$KEY_URL" ]]; then
            COMMENT="$COMMENT ($KEY_URL)"
        fi
        if [[ -n "$EXPIRY_DATE" ]]; then
            COMMENT="$COMMENT - Expires: $EXPIRY_DATE"
        fi
        echo "$COMMENT" >> "$ENV_FILE"
        echo "export ${KEY_NAME}=\"${KEY_VALUE}\"" >> "$ENV_FILE"
        log_success "Added $KEY_NAME to .env (provider: $KEY_PROVIDER)"
    fi

    # Update .env.example
    update_example "$KEY_NAME" "$KEY_URL"

    # Export in current shell
    export "${KEY_NAME}=${KEY_VALUE}"

    # Sync to launchctl for GUI apps (macOS)
    if [[ "$(uname)" == "Darwin" ]]; then
        launchctl setenv "$KEY_NAME" "$KEY_VALUE" 2>/dev/null || true
        log_dim "Synced to launchctl for GUI apps"
    fi

    echo ""
    log_success "Done! $KEY_NAME added to .env"
    log_dim "Note: To sync across machines, install 1Password CLI: brew install 1password-cli"

    # Sync to Docker MCP if available (skip 1Password sync since we just did it)
    if command -v docker &> /dev/null && docker mcp secret ls &> /dev/null; then
        log_info "Syncing to Docker MCP..."
        "$SCRIPT_DIR/sync-docker-mcp" --no-sync 2>/dev/null || log_warn "Run 'sync-docker-mcp --setup' to configure mappings"
    fi
fi
