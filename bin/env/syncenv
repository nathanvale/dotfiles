#!/bin/bash
# syncenv - Sync environment variables from 1Password to .env
# Usage: syncenv [--dry-run]
#
# Two modes:
#   1Password Mode: Pulls keys from 1Password → regenerates .env → syncs launchctl
#   Manual Mode:    Just sources existing .env and syncs to launchctl

set -e

VAULT="Dotfiles"
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/code/dotfiles}"
ENV_FILE="$DOTFILES_DIR/.env"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[0;90m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1" >&2; }
log_dim() { echo -e "${DIM}  $1${NC}"; }

DRY_RUN=false

# Parse arguments
if [[ -n "$1" ]]; then
    case "$1" in
        --dry-run)
            DRY_RUN=true
            log_warn "Dry run mode - no changes will be made"
            ;;
        -h|--help)
            # Help handled below
            ;;
        *)
            log_error "Unknown option: $1"
            echo ""
            echo "Usage: syncenv [--dry-run]"
            echo ""
            echo "Did you mean to run a different command?"
            echo "  syncenv            - Sync .env from 1Password"
            echo "  lsenv              - List environment variables"
            echo "  addenv             - Add a new environment variable"
            echo "  sync-docker-mcp    - Sync .env to Docker MCP"
            exit 1
            ;;
    esac
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: syncenv [--dry-run]"
    echo ""
    echo "Sync environment variables to .env and launchctl."
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --dry-run    Show what would be done without making changes"
    echo "  -h, --help   Show this help message"
    echo ""
    echo -e "${CYAN}Two modes available:${NC}"
    echo ""
    echo -e "  ${GREEN}1Password Mode${NC} (if 'op' CLI is installed & authenticated)"
    echo "    - Pulls all keys from 1Password 'Dotfiles' vault"
    echo "    - Regenerates .env file from 1Password (source of truth)"
    echo "    - Includes provider tags in .env comments"
    echo "    - Syncs all keys to launchctl for GUI apps"
    echo ""
    echo -e "  ${YELLOW}Manual Mode${NC} (fallback if no 1Password)"
    echo "    - Reads existing .env file"
    echo "    - Syncs keys to launchctl for GUI apps"
    echo "    - Does NOT modify .env (you manage it manually)"
    echo ""
    echo -e "${CYAN}Related Commands:${NC}"
    echo "  addenv KEY \"value\" -p provider   Add/update a key"
    echo "  lsenv --providers                List all providers"
    echo "  lsenv --provider <name>          Filter by provider"
    exit 0
fi

# Check if 1Password CLI is available and authenticated
if command -v op &> /dev/null && op vault list &> /dev/null; then
    MODE="1password"
else
    MODE="manual"
fi

if [[ "$MODE" == "1password" ]]; then
    # =========================================================================
    # 1PASSWORD MODE - Pull from 1Password, regenerate .env
    # =========================================================================
    echo ""
    log_dim "Mode: 1Password (synced)"
    log_dim "Source of truth: 1Password vault '$VAULT'"
    echo ""

    log_info "Fetching keys from 1Password vault: $VAULT"

    # Get all items from the Dotfiles vault
    ITEMS=$(op item list --vault "$VAULT" --format json 2>/dev/null || echo "[]")
    ITEM_COUNT=$(echo "$ITEMS" | jq -r 'length')

    if [[ "$ITEM_COUNT" -eq 0 ]]; then
        log_warn "No items found in vault $VAULT"
        echo "Use 'addenv KEY_NAME value provider' to add environment variables"
        exit 0
    fi

    log_info "Found $ITEM_COUNT keys in 1Password"

    # Build the .env file content
    ENV_CONTENT="# .env - Environment variables (auto-generated from 1Password)
# Generated: $(date '+%Y-%m-%d %H:%M:%S')
# Source: 1Password vault \"$VAULT\"
# DO NOT EDIT - use 'addenv KEY value provider' to add/update keys
# Regenerate with: syncenv

"

    # Process each item
    SYNCED_COUNT=0
    while IFS= read -r ITEM_TITLE; do
        if [[ -z "$ITEM_TITLE" ]]; then
            continue
        fi

        # Get the credential field from the item (--reveal to get actual value)
        CREDENTIAL=$(op item get "$ITEM_TITLE" --vault "$VAULT" --fields credential --reveal 2>/dev/null || echo "")

        if [[ -z "$CREDENTIAL" ]]; then
            log_warn "Skipping $ITEM_TITLE (no credential field)"
            continue
        fi

        # Get item details for documentation
        ITEM_JSON=$(op item get "$ITEM_TITLE" --vault "$VAULT" --format json 2>/dev/null || echo "{}")
        ITEM_URL=$(echo "$ITEM_JSON" | jq -r '.urls[0].href // empty' || echo "")
        ITEM_PROVIDER=$(echo "$ITEM_JSON" | jq -r '.tags[0] // empty' || echo "")

        # Build comment with provider and URL
        COMMENT="# ${ITEM_TITLE}"
        if [[ -n "$ITEM_PROVIDER" ]]; then
            COMMENT+=" [provider: ${ITEM_PROVIDER}]"
        fi
        if [[ -n "$ITEM_URL" ]]; then
            COMMENT+=" (${ITEM_URL})"
        fi
        ENV_CONTENT+="${COMMENT}\n"
        ENV_CONTENT+="export ${ITEM_TITLE}=\"${CREDENTIAL}\"\n\n"
        log_dim "$ITEM_TITLE"
        ((SYNCED_COUNT++))
    done < <(echo "$ITEMS" | jq -r '.[].title' | sort)

    if [[ "$DRY_RUN" == true ]]; then
        echo ""
        log_info "Would write to $ENV_FILE:"
        echo "---"
        echo -e "$ENV_CONTENT"
        echo "---"
        exit 0
    fi

    # Write the .env file
    echo -e "$ENV_CONTENT" > "$ENV_FILE"
    chmod 600 "$ENV_FILE"  # Restrict permissions
    log_success "Wrote $SYNCED_COUNT keys to $ENV_FILE"

    # Sync to launchctl for GUI apps (macOS)
    if [[ "$(uname)" == "Darwin" ]]; then
        log_info "Syncing to launchctl (for GUI apps)..."
        LAUNCHCTL_COUNT=0
        while IFS= read -r ITEM_TITLE; do
            if [[ -z "$ITEM_TITLE" ]]; then
                continue
            fi
            CREDENTIAL=$(op item get "$ITEM_TITLE" --vault "$VAULT" --fields credential --reveal 2>/dev/null || echo "")
            if [[ -n "$CREDENTIAL" ]]; then
                launchctl setenv "$ITEM_TITLE" "$CREDENTIAL" 2>/dev/null || true
                ((LAUNCHCTL_COUNT++))
            fi
        done < <(echo "$ITEMS" | jq -r '.[].title' | sort)
        log_success "Synced $LAUNCHCTL_COUNT keys to launchctl"
    fi

    echo ""
    log_info "To load in current shell: source $ENV_FILE"
    log_success "Sync complete!"

else
    # =========================================================================
    # MANUAL MODE - Read existing .env, sync to launchctl only
    # =========================================================================
    echo ""
    log_dim "Mode: Manual (no 1Password)"
    log_dim "Reading from existing .env file"
    echo ""

    if [[ ! -f "$ENV_FILE" ]]; then
        log_error "No .env file found at $ENV_FILE"
        echo ""
        echo "To get started:"
        echo "  1. Create keys with: addenv KEY_NAME \"value\" \"provider\""
        echo "  2. Or install 1Password CLI: brew install 1password-cli"
        exit 1
    fi

    log_info "Reading keys from $ENV_FILE"

    # Count and list keys
    KEY_COUNT=0
    while IFS= read -r line; do
        if [[ "$line" =~ ^export[[:space:]]+([A-Z][A-Z0-9_]*)= ]]; then
            KEY_NAME="${BASH_REMATCH[1]}"
            log_dim "$KEY_NAME"
            ((KEY_COUNT++))
        fi
    done < "$ENV_FILE"

    if [[ "$KEY_COUNT" -eq 0 ]]; then
        log_warn "No keys found in .env"
        echo "Use 'addenv KEY_NAME value provider' to add environment variables"
        exit 0
    fi

    log_info "Found $KEY_COUNT keys in .env"

    if [[ "$DRY_RUN" == true ]]; then
        echo ""
        log_info "Would sync $KEY_COUNT keys to launchctl"
        exit 0
    fi

    # Sync to launchctl for GUI apps (macOS)
    if [[ "$(uname)" == "Darwin" ]]; then
        log_info "Syncing to launchctl (for GUI apps)..."
        LAUNCHCTL_COUNT=0
        while IFS= read -r line; do
            if [[ "$line" =~ ^export[[:space:]]+([A-Z][A-Z0-9_]*)= ]]; then
                KEY_NAME="${BASH_REMATCH[1]}"
                # Extract value
                VALUE="${line#*=}"
                VALUE="${VALUE#\"}"
                VALUE="${VALUE%\"}"
                launchctl setenv "$KEY_NAME" "$VALUE" 2>/dev/null || true
                ((LAUNCHCTL_COUNT++))
            fi
        done < "$ENV_FILE"
        log_success "Synced $LAUNCHCTL_COUNT keys to launchctl"
    fi

    echo ""
    log_info "To load in current shell: source $ENV_FILE"
    log_success "Sync complete!"
    echo ""
    log_dim "Note: In manual mode, .env is not modified."
    log_dim "To enable 1Password sync: brew install 1password-cli"
fi
