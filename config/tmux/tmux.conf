# ~/.tmux.conf - tmux configuration for mnemosyne development
source-file "$HOME/.config/tmux/tmux-night-owl.conf"

# Change the default prefix key to Ctrl-g (more ergonomic than Ctrl-b)
unbind C-b
set-option -g prefix C-g
bind-key C-g send-prefix

# Start window numbering at 1 (instead of 0)
set -g base-index 1

# Start pane numbering at 1 (instead of 0)
setw -g pane-base-index 1

# Renumber windows automatically when one is closed
set -g renumber-windows on

# Keep tmux running when detaching from last session
set -g detach-on-destroy off

# Regular detach behavior (default)
# bind d detach-client  # This is the default, no need to specify

# Increase scrollback buffer size
set -g history-limit 50000

# Improve colors
set -g default-terminal "tmux-256color"

# Enable mouse support
set -g mouse on

# Enable system clipboard integration (OSC 52)
# This allows tmux to directly write to system clipboard
set -g set-clipboard on

# Enable vi mode for copy mode
setw -g mode-keys vi

# Faster command sequences
set -s escape-time 10

# Increase repeat timeout
set -g repeat-time 1000

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity on

# Key bindings
# Reload config file
bind r source-file $HOME/.tmux.conf \; display-message "Config reloaded!"

# Show custom cheatsheet in a popup (Ctrl-g H)
bind H display-popup -w 80% -h 80% -E "$HOME/code/dotfiles/bin/tmux/cheatsheet.sh"

# Split panes using | and -
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %

# Switch panes using Alt-arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes using Ctrl-arrow
bind -n C-Left resize-pane -L 5
bind -n C-Right resize-pane -R 5
bind -n C-Up resize-pane -U 5
bind -n C-Down resize-pane -D 5

# Copy mode bindings (vi style)
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# Better copy/paste integration with system clipboard
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'

# Enable focus events for better vim integration
set -g focus-events on

# Enable hyperlinks for xterm-compatible terminals (including Ghostty)
set -as terminal-features ",xterm*:hyperlinks"

# Set window titles (minimal)
set -g set-titles on
set -g set-titles-string '#S:#W'

# Don't rename windows automatically (for most windows)
# Individual windows can override this
set-option -g allow-rename off
set-window-option -g automatic-rename off

# Update status bar more frequently for better responsiveness
set -g status-interval 2

# RGB color support
set -as terminal-features ",xterm-256color:RGB"
set -as terminal-features ",screen-256color:RGB"

# Pane borders - no status line (disabled)
# These colors will be overridden by the Night Owl theme
set -g pane-border-status off

# Session management
bind s choose-tree -Zs        # Built-in session selector (traditional tmux behavior)
bind w choose-tree -Zw
bind n new-session          # Create new session
bind x confirm-before -p "Kill session #S? (y/n)" kill-session
bind t display-popup -w 80% -h 60% -E "$HOME/code/dotfiles/bin/tmux/tx"  # Tmuxinator project launcher (tx CLI)

# ğŸ¢ WorkSafe Login Automation (Ctrl-G + a)
bind a new-window -c "$HOME/code/dotfiles" -n "WorkSafe" "node bin/worksafe/worksafe-login.mjs || { echo; echo 'Press Enter to close...'; read; }"

# ğŸ¤– AI Agent Spawning (Ctrl-g A then letter)
# Use A-prefix table to avoid conflicts with existing bindings
# Usage: Ctrl-g A c = Claude, Ctrl-g A g = Gemini, Ctrl-g A x = Codex
bind A switch-client -T ai-agents
bind -T ai-agents c run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh claude current horizontal"   # Claude
bind -T ai-agents g run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh gemini current horizontal"   # Gemini
bind -T ai-agents x run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh codex current horizontal"    # Codex
bind -T ai-agents o run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh openai current horizontal"   # OpenAI (legacy)
bind -T ai-agents n run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh claude new horizontal"       # New AI window
bind -T ai-agents v run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh claude current vertical"     # Claude vertical
bind -T ai-agents w run-shell "rm -f /tmp/tmux-wt-switch; tmux display-popup -w 80% -h 70% -E 'WORKTREE_SWITCH_FILE=/tmp/tmux-wt-switch bash $HOME/code/dotfiles/bin/tmux/worktree-ai.sh'; test -s /tmp/tmux-wt-switch && tmux switch-client -t \\$(cat /tmp/tmux-wt-switch); rm -f /tmp/tmux-wt-switch"  # Worktree create
bind -T ai-agents W run-shell "$HOME/code/dotfiles/bin/tmux/worktree-delete-wrapper.sh"  # Worktree delete

# ğŸ”„ AI Tools Upgrade (Ctrl-g U)
# Closes AI panes, upgrades claude-code/codex/gemini-cli via brew, shows new versions
bind U display-popup -w 80% -h 70% -E "$HOME/code/dotfiles/bin/tmux/upgrade-ai-tools.sh"

# Cycle through sessions
bind -r ( switch-client -p  # Previous session
bind -r ) switch-client -n  # Next session
bind L switch-client -l     # Last (previously active) session

# Quick session cycling - press repeatedly to cycle through all sessions
bind -n C-\\ switch-client -n  # Cycle to next session with Ctrl-\

# Quick window switching
bind -r C-h previous-window
# bind -r C-l next-window  # Disabled to allow C-l for clear screen (Ada compatibility)
bind Tab last-window

# Clear screen and tmux history with C-l (for Ada and shell compatibility)
bind -n C-l send-keys C-l \; clear-history

# Direct window switching - multiple binding methods for compatibility
# Option 1: Meta/Alt+number (works if terminal sends ESC sequences)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Option 2: With prefix key (Ctrl-g then number)
# 1-4 are now accordion pane navigation (see ACCORDION MODE section below)
# 5-9 remain for window switching
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# Direct window switching with Ctrl+number (no prefix needed)
bind -n C-1 select-window -t 1
bind -n C-2 select-window -t 2
bind -n C-3 select-window -t 3
bind -n C-4 select-window -t 4
bind -n C-5 select-window -t 5
bind -n C-6 select-window -t 6
bind -n C-7 select-window -t 7
bind -n C-8 select-window -t 8
bind -n C-9 select-window -t 9

# GitHub integration
bind g run-shell "gh browse"

# Pane synchronization
bind y setw synchronize-panes

# Toggle pane zoom (full screen)
bind z resize-pane -Z
bind -n M-z resize-pane -Z  # Alt+z for quick zoom without prefix

# ============================================================================
# ACCORDION MODE (for multi-agent AI pane layouts)
# ============================================================================
# Toggle between tiled layout and accordion (zoomed single pane)
# Space = toggle zoom on current pane
bind Space resize-pane -Z

# Accordion-style pane switching: select pane AND zoom it
# Ctrl-g 1/2/3/4 = jump to pane 1/2/3/4 in accordion (zoomed) mode
bind 1 select-pane -t 1 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind 2 select-pane -t 2 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind 3 select-pane -t 3 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind 4 select-pane -t 4 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"

# F-keys as alternative (keep for compatibility)
bind F1 select-pane -t 1 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind F2 select-pane -t 2 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind F3 select-pane -t 3 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"
bind F4 select-pane -t 4 \; if-shell "[ $(tmux list-panes | wc -l) -gt 1 ]" "resize-pane -Z"

# Quick layout switches
bind T select-layout tiled              # Tiled: all panes equal
bind E select-layout even-horizontal    # Side-by-side (ultrawide friendly)
bind S select-layout even-vertical      # Stacked vertically

# Better splitting - open in same directory
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c run-shell "$HOME/code/dotfiles/bin/tmux/open-vscode.sh"

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Copy mode improvements
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Search improvements
bind / copy-mode \; send-keys "?"
bind ? copy-mode \; send-keys "/"

# Aggressive resize for better multi-client support
setw -g aggressive-resize on

# Display times
set -g display-panes-time 2000
set -g display-time 2000

# Quiet mode
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none

# Broadcast toggle (synchronize panes)
bind B set-window-option synchronize-panes\; display-message "Pane sync: #{?synchronize-panes,ON,OFF}"
