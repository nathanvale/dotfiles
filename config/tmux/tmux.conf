# ~/.tmux.conf - tmux configuration for mnemosyne development
source-file "$HOME/.config/tmux/tmux-night-owl.conf"

# Change the default prefix key to Ctrl-g (more ergonomic than Ctrl-b)
unbind C-b
set-option -g prefix C-g
bind-key C-g send-prefix

# Start window numbering at 1 (instead of 0)
set -g base-index 1

# Start pane numbering at 1 (instead of 0)
setw -g pane-base-index 1

# Renumber windows automatically when one is closed
set -g renumber-windows on

# Keep tmux running when detaching from last session
set -g detach-on-destroy off

# Regular detach behavior (default)
# bind d detach-client  # This is the default, no need to specify

# Increase scrollback buffer size
set -g history-limit 50000

# Improve colors
set -g default-terminal "tmux-256color"

# Enable mouse support
set -g mouse on

# Enable system clipboard integration (OSC 52)
# This allows tmux to directly write to system clipboard
set -g set-clipboard on

# Enable vi mode for copy mode
setw -g mode-keys vi

# Faster command sequences
set -s escape-time 10

# Increase repeat timeout
set -g repeat-time 1000

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity on

# Key bindings
# Reload config file
bind r source-file $HOME/.tmux.conf \; display-message "Config reloaded!"

# Split panes using | and -
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %

# Switch panes using Alt-arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes using Ctrl-arrow
bind -n C-Left resize-pane -L 5
bind -n C-Right resize-pane -R 5
bind -n C-Up resize-pane -U 5
bind -n C-Down resize-pane -D 5

# Copy mode bindings (vi style)
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# Better copy/paste integration with system clipboard
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'

# Enable focus events for better vim integration
set -g focus-events on

# Enable hyperlinks for xterm-compatible terminals (including Ghostty)
set -as terminal-features ",xterm*:hyperlinks"

# Set window titles (minimal)
set -g set-titles on
set -g set-titles-string '#S:#W'

# Don't rename windows automatically (for most windows)
# Individual windows can override this
set-option -g allow-rename off
set-window-option -g automatic-rename off

# Update status bar more frequently for better responsiveness
set -g status-interval 2

# RGB color support
set -as terminal-features ",xterm-256color:RGB"
set -as terminal-features ",screen-256color:RGB"

# Pane borders - no status line (disabled)
# These colors will be overridden by the Night Owl theme
set -g pane-border-status off

# Session management
bind s choose-tree -Zs        # Built-in session selector (traditional tmux behavior)
bind w choose-tree -Zw
bind n new-session          # Create new session
bind x confirm-before -p "Kill session #S? (y/n)" kill-session
bind t display-popup -w 80% -h 60% -E "$HOME/code/dotfiles/bin/tmux/tx"  # Tmuxinator project launcher (tx CLI)

# ğŸ—‚ï¸  Vault Management (ADHD-Friendly)
bind V display-popup -w 90% -h 85% -E "$HOME/code/dotfiles/bin/vault manage"  # Interactive manager (checkboxes)
bind H display-popup -w 70% -h 60% -E "$HOME/code/dotfiles/bin/vault health"  # Health check & repair
bind v run-shell "$HOME/code/dotfiles/bin/vault open"                        # Open current project vault

# ğŸ¤– Parallel Claude Agent Launcher (Dynamic)
bind P display-popup -w 80% -h 60% -E "$HOME/code/dotfiles/apps/taskdock/ux/tmux/parallel-claude-menu.sh"  # Launch N agents
bind M display-popup -w 90% -h 85% -E "$HOME/code/dotfiles/apps/taskdock/ux/tmux/task-monitor.sh"          # Task monitor dashboard

# ğŸ¢ WorkSafe Login Automation (Ctrl-G + a)
bind a new-window -c "$HOME/code/dotfiles" -n "WorkSafe" "node bin/worksafe/worksafe-login.mjs || { echo; echo 'Press Enter to close...'; read; }"

# ğŸ¤– AI Agent Spawning (Ctrl-G + Shift+letter)
# Dynamically spawn AI agents in current session
bind C run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh claude current horizontal"     # Ctrl-g + C = Spawn Claude
bind G run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh gemini current horizontal"     # Ctrl-g + G = Spawn Gemini
bind O run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh openai current horizontal"     # Ctrl-g + O = Spawn OpenAI
bind X run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh codex current horizontal"      # Ctrl-g + X = Spawn Codex
bind N run-shell "$HOME/.config/tmuxinator/scripts/spawn-ai-agent.sh claude new horizontal"         # Ctrl-g + N = New AI window

# Cycle through sessions
bind -r ( switch-client -p  # Previous session
bind -r ) switch-client -n  # Next session
bind L switch-client -l     # Last (previously active) session

# Quick session cycling - press repeatedly to cycle through all sessions
bind -n C-\\ switch-client -n  # Cycle to next session with Ctrl-\

# Quick window switching
bind -r C-h previous-window
# bind -r C-l next-window  # Disabled to allow C-l for clear screen (Ada compatibility)
bind Tab last-window

# Clear screen and tmux history with C-l (for Ada and shell compatibility)
bind -n C-l send-keys C-l \; clear-history

# Direct window switching - multiple binding methods for compatibility
# Option 1: Meta/Alt+number (works if terminal sends ESC sequences)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Option 2: With prefix key (Ctrl-g then number)
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# Direct window switching with Ctrl+number (no prefix needed)
bind -n C-1 select-window -t 1
bind -n C-2 select-window -t 2
bind -n C-3 select-window -t 3
bind -n C-4 select-window -t 4
bind -n C-5 select-window -t 5
bind -n C-6 select-window -t 6
bind -n C-7 select-window -t 7
bind -n C-8 select-window -t 8
bind -n C-9 select-window -t 9

# GitHub integration
bind g run-shell "gh browse"

# Pane synchronization
bind y setw synchronize-panes

# Toggle pane zoom (full screen)
bind z resize-pane -Z
bind -n M-z resize-pane -Z  # Alt+z for quick zoom without prefix

# Better splitting - open in same directory
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind z new-window -c "#{pane_current_path}"
bind c run-shell "$HOME/code/dotfiles/bin/tmux/open-vscode.sh"

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Copy mode improvements
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Search improvements
bind / copy-mode \; send-keys "?"
bind ? copy-mode \; send-keys "/"

# Aggressive resize for better multi-client support
setw -g aggressive-resize on

# Display times
set -g display-panes-time 2000
set -g display-time 2000

# Quiet mode
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none

# ============================================================================
# CLOUD AGENT WORKFLOW ENHANCEMENTS
# ============================================================================

# Source cloud-agents config if session name matches
if-shell '[ "#{session_name}" = "cloud-agents" ]' \
    "source-file $HOME/.config/tmux/tmux-cloud-agents.conf"

# Quick lock management keybindings (available in all sessions)
bind L display-popup -w 90% -h 85% -E "$HOME/code/dotfiles/apps/taskdock/ux/tmux/show-locks-popup.sh"
bind C run-shell "$HOME/code/dotfiles/apps/taskdock/bin/taskdock locks clean && tmux display-message 'âœ… Cleaned stale locks'"

# Spawn worker agent
bind W split-window -h -c "#{pane_current_path}" "$HOME/code/dotfiles/apps/taskdock/ux/tmux/next-worker.sh"

# Broadcast toggle (synchronize panes)
bind B set-window-option synchronize-panes\; display-message "Pane sync: #{?synchronize-panes,ON,OFF}"
